<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schedule Assignment - Brown Ford University</title>
    <link rel="icon" type="image/png" th:href="@{/images/logo-circle.png}">
    <link
        href="https://fonts.googleapis.com/css2?family=Alice&family=Cinzel&family=Cinzel+Decorative&family=Cormorant+Garamond&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar-nav.css}">
    <script th:src="@{/js/sidebar-nav.js}"></script>
    <script th:src="@{/js/headerFooter.js}"></script>
    <script th:src="@{/js/notifications.js}"></script>
</head>

<body>
    <admin-header></admin-header>

    <div class="background-container">
        <div class="background-image"></div>

        <div class="content-wrapper" id="contentWrapper">
            <main class="admin-dashboard-content">
                <!-- Header Section -->
                <section class="welcome-section">
                    <div class="welcome-header">
                        <div class="welcome-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24"
                                fill="none" stroke="#6B3A1D" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" />
                            </svg>
                        </div>
                        <div class="welcome-text">
                            <h2>Schedule Assignment</h2>
                            <p>Assign faculty and schedules to section courses</p>
                        </div>
                    </div>
                </section>

                <!-- Step 1: Section Selection -->
                <section class="content-panel" id="sectionSelectionPanel">
                    <div class="panel-header">
                        <h2 class="section-title">Step 1: Select Section</h2>
                    </div>
                    <div class="panel-content">
                        <div class="section-selector-container">
                            <div class="selector-group">
                                <label for="sectionSelect" class="selector-label">Choose a section to manage course
                                    assignments:</label>
                                <div class="selector-wrapper">
                                    <select id="sectionSelect" class="section-select">
                                        <option value="">-- Select a Section --</option>
                                    </select>
                                    <div class="selector-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            viewBox="0 0 24 24" fill="none" stroke="#6B3A1D" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div class="section-info" id="sectionInfo" style="display: none;">
                                <div class="info-card">
                                    <div class="info-header">
                                        <h3>Section Details</h3>
                                    </div>
                                    <div class="info-content">
                                        <div class="info-item">
                                            <span class="info-label">Section Code:</span>
                                            <span class="info-value" id="selectedSectionCode">-</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Program:</span>
                                            <span class="info-value" id="selectedSectionProgram">-</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Max Students:</span>
                                            <span class="info-value" id="selectedSectionMaxStudents">-</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Status:</span>
                                            <span class="info-value" id="selectedSectionStatus">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Step 2: Course Assignment Table -->
                <section class="content-panel" id="courseAssignmentPanel" style="display: none;">
                    <div class="panel-header">
                        <h2 class="section-title">Step 2: Assign Faculty & Schedule</h2>
                        <div class="panel-actions">
                            <button class="btn btn-secondary" id="saveAllBtn" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17,21 17,13 7,13 7,21"></polyline>
                                    <polyline points="7,3 7,8 15,8"></polyline>
                                </svg>
                                Save All Changes
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="assignment-summary" id="assignmentSummary">
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <span class="stat-number" id="totalCourses">0</span>
                                    <span class="stat-label">Total Courses</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="assignedCourses">0</span>
                                    <span class="stat-label">Fully Assigned</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="partialCourses">0</span>
                                    <span class="stat-label">Partially Assigned</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="unassignedCourses">0</span>
                                    <span class="stat-label">Unassigned</span>
                                </div>
                            </div>
                        </div>

                        <div class="assignment-table-container">
                            <table class="assignment-table" id="courseAssignmentTable">
                                <thead>
                                    <tr>
                                        <th>Course</th>
                                        <th>Year Level</th>
                                        <th>Semester</th>
                                        <th>Faculty Assignment</th>
                                        <th>Schedule</th>
                                        <th>Room</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="courseAssignmentTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <div class="empty-state" id="emptyCourseState" style="display: none;">
                            <div class="empty-state-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24"
                                    fill="none" stroke="#8B4513" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                                </svg>
                            </div>
                            <h3>No Courses Found</h3>
                            <p>This section doesn't have any curriculum courses assigned yet.</p>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Assignment Modal -->
        <div id="assignmentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="assignmentModalTitle">Assign Faculty & Schedule</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="assignmentForm">
                        <input type="hidden" id="modalCurriculumCourseId" />
                        <input type="hidden" id="modalSectionId" />
                        <input type="hidden" id="modalFacultyAssignmentId" />

                        <!-- Course Information (Read-only) -->
                        <div class="form-section">
                            <h4>Course Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="modalCourseCode">Course Code</label>
                                    <input type="text" id="modalCourseCode" class="form-control" readonly />
                                </div>
                                <div class="form-group">
                                    <label for="modalCourseTitle">Course Title</label>
                                    <input type="text" id="modalCourseTitle" class="form-control" readonly />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="modalYearLevel">Year Level</label>
                                    <input type="text" id="modalYearLevel" class="form-control" readonly />
                                </div>
                                <div class="form-group">
                                    <label for="modalSemester">Semester</label>
                                    <input type="text" id="modalSemester" class="form-control" readonly />
                                </div>
                            </div>
                        </div>

                        <!-- Faculty Assignment -->
                        <div class="form-section">
                            <h4>Faculty Assignment</h4>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="modalFacultySelect">Select Faculty Member</label>
                                    <select id="modalFacultySelect" class="form-control">
                                        <option value="">-- Choose Faculty --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Details -->
                        <div class="form-section">
                            <h4>Schedule Details</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="modalDay">Day</label>
                                    <select id="modalDay" class="form-control" required>
                                        <option value="">-- Select Day --</option>
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="modalRoom">Room</label>
                                    <input type="text" id="modalRoom" class="form-control"
                                        placeholder="e.g., Room 101" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="modalStartTime">Start Time</label>
                                    <input type="time" id="modalStartTime" class="form-control" required />
                                </div>
                                <div class="form-group">
                                    <label for="modalEndTime">End Time</label>
                                    <input type="time" id="modalEndTime" class="form-control" required />
                                </div>
                            </div>
                        </div>

                        <!-- School Year Input -->
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="modalSchoolYear">School Year <span
                                            style="color: rgb(201, 40, 40); font-size: 0.9em;">(Format: YYYY-YYYY, e.g.,
                                            2025-2026)</span></label>
                                    <input type="text" id="modalSchoolYear" class="form-control" maxlength="9"
                                        placeholder="e.g., 2025-2026" required />
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelAssignmentBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="saveAssignmentBtn">Save
                                Assignment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script th:src="@{/js/modal-global.js}"></script>

        <script>
            // Global variables
            let sectionList = [];
            let facultyList = [];
            let currentSectionId = null;
            let currentCurriculumCourses = [];
            let currentFacultyAssignments = [];

            // DOM elements
            const sectionSelect = document.getElementById('sectionSelect');
            const sectionInfo = document.getElementById('sectionInfo');
            const courseAssignmentPanel = document.getElementById('courseAssignmentPanel');
            const assignmentModal = document.getElementById('assignmentModal');
            const assignmentForm = document.getElementById('assignmentForm');
            const emptyCourseState = document.getElementById('emptyCourseState');

            document.addEventListener('DOMContentLoaded', function () {
                initializeEventListeners();
                loadInitialData();
            });

            function initializeEventListeners() {
                // Section selection
                sectionSelect.addEventListener('change', handleSectionChange);

                // Modal controls
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', closeModal);
                });
                document.getElementById('cancelAssignmentBtn').addEventListener('click', closeModal);

                // Form submission
                assignmentForm.addEventListener('submit', handleAssignmentSubmit);

                // Save all button
                document.getElementById('saveAllBtn').addEventListener('click', saveAllAssignments);

                // Close modal on outside click
                window.addEventListener('click', function (event) {
                    if (event.target === assignmentModal) {
                        closeModal();
                    }
                });
            }

            async function loadInitialData() {
                try {
                    await Promise.all([
                        loadSections(),
                        loadFaculty()
                    ]);
                } catch (error) {
                    console.error('Error loading initial data:', error);
                    showNotification('Failed to load initial data', 'error');
                }
            }

            async function loadSections() {
                try {
                    const response = await fetch('/api/sections');
                    if (!response.ok) throw new Error('Failed to fetch sections');
                    sectionList = await response.json();
                    populateSectionDropdown();
                } catch (error) {
                    console.error('Error loading sections:', error);
                    throw error;
                }
            }

            async function loadFaculty() {
                try {
                    const response = await fetch('/api/faculty');
                    if (!response.ok) throw new Error('Failed to fetch faculty');
                    facultyList = await response.json();
                } catch (error) {
                    console.error('Error loading faculty:', error);
                    throw error;
                }
            }

            function populateSectionDropdown() {
                sectionSelect.innerHTML = '<option value="">-- Select a Section --</option>';
                sectionList.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.id;
                    option.textContent = `${section.sectionCode} - ${section.programName || section.programCode || 'Unknown Program'}`;
                    sectionSelect.appendChild(option);
                });
            }

            async function handleSectionChange() {
                const sectionId = sectionSelect.value;

                if (!sectionId) {
                    hideSectionInfo();
                    hideCourseAssignmentPanel();
                    return;
                }

                currentSectionId = sectionId;
                const selectedSection = sectionList.find(s => s.id == sectionId);

                if (selectedSection) {
                    showSectionInfo(selectedSection);
                    await loadSectionCourses(sectionId);
                }
            }

            function showSectionInfo(section) {
                document.getElementById('selectedSectionCode').textContent = section.sectionCode;
                document.getElementById('selectedSectionProgram').textContent = section.programName || section.programCode || 'Unknown';
                document.getElementById('selectedSectionMaxStudents').textContent = section.maxStudents || 'N/A';
                document.getElementById('selectedSectionStatus').textContent = section.status || 'N/A';
                sectionInfo.style.display = 'block';
            }

            function hideSectionInfo() {
                sectionInfo.style.display = 'none';
            }

            async function loadSectionCourses(sectionId) {
                try {
                    // Load curriculum courses for the section
                    const coursesResponse = await fetch(`/api/sections/${sectionId}/curriculum-courses`);
                    if (!coursesResponse.ok) throw new Error('Failed to fetch curriculum courses');
                    currentCurriculumCourses = await coursesResponse.json();

                    // Load existing faculty assignments for this section
                    const assignmentsResponse = await fetch(`/api/faculty-assignments?sectionId=${sectionId}`);
                    if (!assignmentsResponse.ok) throw new Error('Failed to fetch faculty assignments');
                    currentFacultyAssignments = await assignmentsResponse.json();

                    renderCourseAssignmentTable();
                    showCourseAssignmentPanel();
                } catch (error) {
                    console.error('Error loading section courses:', error);
                    showNotification('Failed to load section courses', 'error');
                }
            }

            function renderCourseAssignmentTable() {
                const tbody = document.getElementById('courseAssignmentTableBody');

                if (!currentCurriculumCourses.length) {
                    tbody.innerHTML = '';
                    emptyCourseState.style.display = 'block';
                    document.querySelector('.assignment-table-container').style.display = 'none';
                    updateAssignmentSummary();
                    return;
                }

                emptyCourseState.style.display = 'none';
                document.querySelector('.assignment-table-container').style.display = 'block';

                tbody.innerHTML = currentCurriculumCourses.map(course => {
                    const assignment = currentFacultyAssignments.find(fa => fa.curriculumCourseId === course.id);
                    const status = getAssignmentStatus(assignment);
                    const yearLevelText = getYearLevelText(course.yearLevel);

                    return `
                    <tr data-course-id="${course.id}">
                        <td>
                            <div class="course-info">
                                <strong>${course.course?.courseCode || 'N/A'}</strong>
                                <div class="course-title">${course.course?.courseTitle || 'N/A'}</div>
                            </div>
                        </td>
                        <td>${yearLevelText}</td>
                        <td>${course.semester || 'N/A'}</td>
                        <td>
                            <div class="faculty-assignment">
                                ${assignment?.faculty || '<span class="text-muted">Not assigned</span>'}
                            </div>
                        </td>
                        <td>
                            <div class="schedule-info">
                                ${assignment?.day && assignment?.startTime && assignment?.endTime
                            ? `${assignment.day}<br><small>${assignment.startTime} - ${assignment.endTime}</small>`
                            : '<span class="text-muted">Not scheduled</span>'
                        }
                            </div>
                        </td>
                        <td>
                            <div class="room-info">
                                ${assignment?.room || '<span class="text-muted">Not assigned</span>'}
                            </div>
                        </td>
                        <td>${getStatusBadge(status)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="openAssignmentModal(${course.id})" title="Assign/Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2 2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    ${assignment ? 'Edit' : 'Assign'}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                }).join('');

                updateAssignmentSummary();
            }

            function updateAssignmentSummary() {
                const total = currentCurriculumCourses.length;
                let assigned = 0;
                let partial = 0;
                let unassigned = 0;

                currentCurriculumCourses.forEach(course => {
                    const assignment = currentFacultyAssignments.find(fa => fa.curriculumCourseId === course.id);
                    const status = getAssignmentStatus(assignment);

                    switch (status) {
                        case 'assigned': assigned++; break;
                        case 'partial': partial++; break;
                        case 'unassigned': unassigned++; break;
                    }
                });

                document.getElementById('totalCourses').textContent = total;
                document.getElementById('assignedCourses').textContent = assigned;
                document.getElementById('partialCourses').textContent = partial;
                document.getElementById('unassignedCourses').textContent = unassigned;

                // Show save all button if there are changes
                const hasAssignments = assigned > 0 || partial > 0;
                document.getElementById('saveAllBtn').style.display = hasAssignments ? 'block' : 'none';
            }

            function getAssignmentStatus(assignment) {
                if (!assignment) return 'unassigned';

                const hasAllRequired = assignment.facultyId && assignment.day &&
                    assignment.startTime && assignment.endTime && assignment.room;

                if (hasAllRequired) return 'assigned';

                const hasSomeRequired = assignment.facultyId || assignment.day ||
                    assignment.startTime || assignment.endTime || assignment.room;

                return hasSomeRequired ? 'partial' : 'unassigned';
            }

            function getStatusBadge(status) {
                const statusConfig = {
                    'assigned': { class: 'status-assigned', text: 'Fully Assigned' },
                    'partial': { class: 'status-partial', text: 'Partially Assigned' },
                    'unassigned': { class: 'status-unassigned', text: 'Unassigned' }
                };

                const config = statusConfig[status] || statusConfig['unassigned'];
                return `<span class="status-badge ${config.class}">${config.text}</span>`;
            }

            function getYearLevelText(yearLevel) {
                const yearLevels = {
                    1: 'First Year',
                    2: 'Second Year',
                    3: 'Third Year',
                    4: 'Fourth Year'
                };
                return yearLevels[yearLevel] || 'N/A';
            }

            function showCourseAssignmentPanel() {
                courseAssignmentPanel.style.display = 'block';
            }

            function hideCourseAssignmentPanel() {
                courseAssignmentPanel.style.display = 'none';
            }

            function openAssignmentModal(curriculumCourseId) {
                const course = currentCurriculumCourses.find(c => c.id === curriculumCourseId);
                const assignment = currentFacultyAssignments.find(fa => fa.curriculumCourseId === curriculumCourseId);

                if (!course) return;

                // Populate course information
                document.getElementById('modalCurriculumCourseId').value = curriculumCourseId;
                document.getElementById('modalSectionId').value = currentSectionId;
                document.getElementById('modalFacultyAssignmentId').value = assignment?.id || '';
                document.getElementById('modalCourseCode').value = course.course?.courseCode || '';
                document.getElementById('modalCourseTitle').value = course.course?.courseTitle || '';
                document.getElementById('modalYearLevel').value = getYearLevelText(course.yearLevel);
                document.getElementById('modalSemester').value = course.semester || '';

                // Populate faculty dropdown
                populateFacultyDropdown(assignment?.facultyId);

                // Populate assignment data if exists
                if (assignment) {
                    document.getElementById('modalDay').value = assignment.day || '';
                    document.getElementById('modalRoom').value = assignment.room || '';
                    document.getElementById('modalStartTime').value = assignment.startTime || '';
                    document.getElementById('modalEndTime').value = assignment.endTime || '';
                    document.getElementById('modalSchoolYear').value = assignment.schoolYear || '';
                    document.getElementById('assignmentModalTitle').textContent = 'Edit Faculty & Schedule Assignment';
                } else {
                    // Clear form for new assignment
                    document.getElementById('modalDay').value = '';
                    document.getElementById('modalRoom').value = '';
                    document.getElementById('modalStartTime').value = '';
                    document.getElementById('modalEndTime').value = '';
                    document.getElementById('modalSchoolYear').value = '';
                    document.getElementById('assignmentModalTitle').textContent = 'Assign Faculty & Schedule';
                }

                assignmentModal.style.display = 'block';
            }

            function populateFacultyDropdown(selectedFacultyId) {
                const facultySelect = document.getElementById('modalFacultySelect');
                facultySelect.innerHTML = '<option value="">-- Choose Faculty --</option>';

                facultyList.forEach(faculty => {
                    const option = document.createElement('option');
                    option.value = faculty.id;
                    option.textContent = faculty.name || `${faculty.firstName} ${faculty.lastName}` || 'Unknown Faculty';
                    if (selectedFacultyId && faculty.id == selectedFacultyId) {
                        option.selected = true;
                    }
                    facultySelect.appendChild(option);
                });
            }

            async function handleAssignmentSubmit(event) {
                event.preventDefault();

                const facultyValue = document.getElementById('modalFacultySelect').value;
                const roomValue = document.getElementById('modalRoom').value;
                const schoolYearValue = document.getElementById('modalSchoolYear').value;
                const assignmentData = {
                    id: document.getElementById('modalFacultyAssignmentId').value || null,
                    curriculumCourseId: parseInt(document.getElementById('modalCurriculumCourseId').value),
                    sectionId: parseInt(document.getElementById('modalSectionId').value),
                    facultyId: facultyValue ? parseInt(facultyValue) : null,
                    semester: document.getElementById('modalSemester').value,
                    yearLevel: getCurrentYearLevel(),
                    schoolYear: schoolYearValue,
                    day: document.getElementById('modalDay').value,
                    startTime: document.getElementById('modalStartTime').value,
                    endTime: document.getElementById('modalEndTime').value,
                    room: roomValue ? roomValue : null
                };

                // Validation
                if (!assignmentData.day || !assignmentData.startTime || !assignmentData.endTime) {
                    showNotification('Please fill in all schedule details (day, start time, end time)', 'error');
                    return;
                }

                if (assignmentData.startTime >= assignmentData.endTime) {
                    showNotification('End time must be after start time', 'error');
                    return;
                }

                try {
                    const isUpdate = !!assignmentData.id;
                    const url = isUpdate
                        ? `/api/faculty-assignments/with-schedule/${assignmentData.id}`
                        : '/api/faculty-assignments/with-schedule';
                    const method = isUpdate ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(assignmentData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to save assignment');
                    }

                    closeModal();
                    showNotification('Assignment saved successfully', 'success');

                    // Reload the section courses to reflect changes
                    await loadSectionCourses(currentSectionId);

                } catch (error) {
                    console.error('Error saving assignment:', error);
                    showNotification('Failed to save assignment', 'error');
                }
            }

            function getCurrentYearLevel() {
                const course = currentCurriculumCourses.find(c =>
                    c.id === parseInt(document.getElementById('modalCurriculumCourseId').value)
                );
                return course?.yearLevel || 1;
            }

            function closeModal() {
                assignmentModal.style.display = 'none';
                assignmentForm.reset();
            }

            function showNotification(message, type = 'info') {
                // Simple notification system - you can enhance this
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                font-family: 'Alice', serif;
                z-index: 10000;
                ${type === 'success' ? 'background-color: #28a745;' : ''}
                ${type === 'error' ? 'background-color: #dc3545;' : ''}
                ${type === 'info' ? 'background-color: #17a2b8;' : ''}
            `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            async function saveAllAssignments() {
                // This could be implemented to save all pending changes at once
                showNotification('All assignments are already saved individually', 'info');
            }
        </script>

        <style>
            /* Section Selection Styles */
            .section-selector-container {
                padding: 20px;
            }

            .selector-group {
                margin-bottom: 30px;
            }

            .selector-label {
                display: block;
                font-family: "Cinzel", serif;
                font-weight: 600;
                color: #6B3A1D;
                margin-bottom: 10px;
                font-size: 1.1rem;
            }

            .selector-wrapper {
                position: relative;
                display: inline-block;
                width: 100%;
                max-width: 400px;
            }

            .section-select {
                width: 100%;
                padding: 12px 40px 12px 16px;
                border: 2px solid #D4B896;
                border-radius: 8px;
                font-family: "Alice", serif;
                font-size: 1rem;
                background-color: white;
                color: #333;
                appearance: none;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .section-select:focus {
                outline: none;
                border-color: #8B4513;
                box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
            }

            .selector-icon {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
            }

            .info-card {
                background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC0 100%);
                border: 1px solid #D4B896;
                border-radius: 12px;
                padding: 20px;
                margin-top: 20px;
            }

            .info-header h3 {
                font-family: "Cinzel", serif;
                color: #6B3A1D;
                margin: 0 0 15px 0;
                font-size: 1.2rem;
            }

            .info-content {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .info-item {
                display: flex;
                flex-direction: column;
            }

            .info-label {
                font-family: "Cinzel", serif;
                font-weight: 600;
                color: #8B4513;
                font-size: 0.9rem;
                margin-bottom: 4px;
            }

            .info-value {
                font-family: "Alice", serif;
                color: #333;
                font-size: 1rem;
            }

            /* Assignment Summary Styles */
            .assignment-summary {
                background: linear-gradient(135deg, #F5F1E8 0%, #E8DCC0 100%);
                border: 1px solid #D4B896;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 30px;
            }

            .summary-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 20px;
            }

            .stat-item {
                text-align: center;
                padding: 15px;
                background: rgba(255, 255, 255, 0.7);
                border-radius: 8px;
                border: 1px solid rgba(139, 69, 19, 0.1);
            }

            .stat-number {
                display: block;
                font-family: "Cinzel", serif;
                font-size: 2rem;
                font-weight: bold;
                color: #6B3A1D;
                margin-bottom: 5px;
            }

            .stat-label {
                font-family: "Alice", serif;
                color: #8B4513;
                font-size: 0.9rem;
            }

            /* Assignment Table Styles */
            .assignment-table-container {
                background: white;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                border: 1px solid #D4B896;
            }

            .assignment-table {
                width: 100%;
                border-collapse: collapse;
            }

            .assignment-table th {
                background: linear-gradient(135deg, #8B4513 0%, #6B3A1D 100%);
                color: white;
                padding: 15px 12px;
                text-align: left;
                font-family: "Cinzel", serif;
                font-weight: 600;
                font-size: 0.9rem;
            }

            .assignment-table td {
                padding: 15px 12px;
                border-bottom: 1px solid #E8DCC0;
                font-family: "Alice", serif;
                vertical-align: top;
            }

            .assignment-table tr:hover {
                background-color: #F9F7F4;
            }

            .course-info strong {
                color: #6B3A1D;
                font-family: "Cinzel", serif;
                font-size: 1rem;
            }

            .course-title {
                color: #666;
                font-size: 0.9rem;
                margin-top: 4px;
            }

            .faculty-assignment,
            .schedule-info,
            .room-info {
                font-size: 0.9rem;
            }

            .text-muted {
                color: #999;
                font-style: italic;
            }

            /* Status Badge Styles */
            .status-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 600;
                font-family: "Alice", serif;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-assigned {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .status-partial {
                background-color: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .status-unassigned {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            /* Modal Styles */
            .form-section {
                margin-bottom: 25px;
                padding-bottom: 20px;
                border-bottom: 1px solid #E8DCC0;
            }

            .form-section:last-of-type {
                border-bottom: none;
                margin-bottom: 0;
            }

            .form-section h4 {
                font-family: "Cinzel", serif;
                color: #6B3A1D;
                margin: 0 0 15px 0;
                font-size: 1.1rem;
            }

            .form-group.full-width {
                grid-column: 1 / -1;
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #8B4513;
            }

            .empty-state-icon {
                margin-bottom: 20px;
            }

            .empty-state h3 {
                font-family: "Cinzel", serif;
                margin: 0 0 10px 0;
                font-size: 1.5rem;
            }

            .empty-state p {
                font-family: "Alice", serif;
                margin: 0;
                font-size: 1rem;
                opacity: 0.8;
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .summary-stats {
                    grid-template-columns: repeat(2, 1fr);
                }

                .info-content {
                    grid-template-columns: 1fr;
                }

                .assignment-table {
                    font-size: 0.8rem;
                }

                .assignment-table th,
                .assignment-table td {
                    padding: 10px 8px;
                }
            }

            @media (max-width: 480px) {
                .summary-stats {
                    grid-template-columns: 1fr;
                }
            }
        </style>
</body>

</html>