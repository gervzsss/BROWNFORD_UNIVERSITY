<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brown Ford University - Enrollment Management</title>
  <link rel="stylesheet" th:href="@{/css/home.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar-nav.css}" />
  <link rel="stylesheet" th:href="@{/css/common.css}" />
  <link
    href="https://fonts.googleapis.com/css2?family=Alice&family=Cinzel&family=Cinzel+Decorative&family=Cormorant+Garamond&display=swap"
    rel="stylesheet" />
</head>

<body>
  <div class="background-container">
    <div class="background-image"></div>
    <!-- Header -->
    <header class="header">
      <button class="sidebar-toggle" id="sidebarToggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8B4513"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      <div class="logo-container">
        <div class="logo">
          <div class="logo-inner">
            <img th:src="@{/images/logo.png}" alt="Brown Ford University Logo" class="university-logo" />
          </div>
        </div>
        <h1 class="university-name">Brown Ford University</h1>
      </div>
      <div class="header-icons">
        <div class="notification-icon">
          <a href="#" class="notification-link" id="notificationToggle">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
              stroke="#8B4513" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
          </a>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h3>Notifications</h3>
              <a href="#" class="mark-all-read">Mark all as read</a>
            </div>
            <div class="notification-list">
              <p>No notifications available.</p>
            </div>
            <div class="notification-footer">
              <a href="#" class="view-all">View All Notifications</a>
            </div>
          </div>
        </div>
        <div class="logout-icon">
          <a th:href="@{/logout}" class="logout-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
              stroke="#8B4513" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
            </svg>
          </a>
        </div>
      </div>
    </header>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img th:src="@{/images/logo.png}" alt="Brown Ford University Logo">
          <span class="sidebar-title">Admin Portal</span>
        </div>
        <button class="sidebar-close" id="sidebarClose">&times;</button>
      </div>
      <div class="sidebar-content">
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item">
            <a th:href="@{/admin-dashboard}" class="sidebar-nav-link">
              <span class="sidebar-nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
              </span>
              <span class="sidebar-nav-text">Dashboard</span>
            </a>
          </li>

          <div class="sidebar-section-title">Academic Management</div>

          <li class="sidebar-nav-item">
            <a th:href="@{/admin-programs}" class="sidebar-nav-link">
              <span class="sidebar-nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </span>
              <span class="sidebar-nav-text">Program Management</span>
            </a>
          </li>

          <li class="sidebar-nav-item">
            <a th:href="@{/admin-courses}" class="sidebar-nav-link">
              <span class="sidebar-nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
              </span>
              <span class="sidebar-nav-text">Courses</span>
            </a>
          </li>

          <li class="sidebar-nav-item">
            <a th:href="@{/admin-sections}" class="sidebar-nav-link">
              <span class="sidebar-nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </span>
              <span class="sidebar-nav-text">Sections</span>
            </a>
          </li>

          <li class="sidebar-nav-item">
            <a th:href="@{/admin-enrollment}" class="sidebar-nav-link">
              <span class="sidebar-nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <line x1="20" y1="8" x2="20" y2="14"></line>
                  <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
              </span>
              <span class="sidebar-nav-text">Enrollment</span>
            </a>
          </li>

          <div class="sidebar-section-title">User Management</div>

          <li class="sidebar-nav-item">
            <a th:href="@{/admin-users}" class="sidebar-nav-link">
              <span class="sidebar-nav-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </span>
              <span class="sidebar-nav-text">User Management</span>
            </a>
          </li>

          <li class="sidebar-nav-item sidebar-dropdown">
            <button class="sidebar-dropdown-toggle">
              <span class="sidebar-dropdown-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <line x1="20" y1="8" x2="20" y2="14"></line>
                  <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
              </span>
              <span class="sidebar-dropdown-text">Faculty</span>
              <span class="sidebar-dropdown-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </span>
            </button>
            <div class="sidebar-dropdown-menu">
              <a th:href="@{/admin-faculty-list}" class="sidebar-dropdown-item">Faculty List</a>
              <a th:href="@{/admin-faculty-workload}" class="sidebar-dropdown-item">Workload
                Management</a>
              <a th:href="@{/admin-faculty-evaluation}" class="sidebar-dropdown-item">Evaluations</a>
            </div>
          </li>

          <li class="sidebar-nav-item sidebar-dropdown">
            <button class="sidebar-dropdown-toggle">
              <span class="sidebar-dropdown-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                </svg>
              </span>
              <span class="sidebar-dropdown-text">Students</span>
              <span class="sidebar-dropdown-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </span>
            </button>
            <div class="sidebar-dropdown-menu">
              <a th:href="@{/admin-student-list}" class="sidebar-dropdown-item">Student List</a>
              <a th:href="@{/admin-student-records}" class="sidebar-dropdown-item">Academic Records</a>
            </div>
          </li>
        </ul>
      </div>
      <div class="sidebar-footer">
        <p>Brown Ford University &copy; 2025</p>
        <p>Admin Portal v1.0</p>
      </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="content-wrapper" id="contentWrapper">
      <main class="dashboard-content">
        <section class="welcome-section">
          <div class="welcome-header">
            <div class="welcome-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none"
                stroke="#6B3A1D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
            </div>
            <div class="welcome-text">
              <h2>Enrollment Management</h2>
              <p>Manage student enrollments for the academic program</p>
            </div>
          </div>
        </section>
        <section class="content-panel" id="enrollmentPanel">
          <div class="panel-header">
            <h2 class="section-title">Enrollment Management</h2>
          </div>
          <div class="panel-content">
            <div class="user-controls">
              <div class="search-filter-container">
                <div class="search-container">
                  <input type="text" placeholder="Search students..." id="enrollmentSearchInput" />
                  <button class="search-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="action-buttons">
                <button id="addEnrollmentBtn" class="add-user-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14m7-7H5" />
                  </svg>
                  Add Enrollment
                </button>
                <button id="exportEnrollmentBtn" class="export-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Export
                </button>
              </div>
            </div>
            <div class="table-container">
              <table class="data-table" id="enrollmentTable">
                <thead>
                  <tr>
                    <th>Student ID</th>
                    <th>Student Name</th>
                    <th>Program</th>
                    <th>Section</th>
                    <th>Year Level</th>
                    <th>Enrolled Courses</th>
                    <th>Units</th>
                    <th>Enrollment Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="enrollmentTableBody">
                  <!-- Enrollment data will be loaded dynamically from the database -->
                </tbody>
              </table>
            </div>
            <div class="pagination" id="enrollmentPaginationContainer">
              <div class="empty-pagination-message">
                <p>Pagination will appear when there are enough records to display multiple pages.</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
  <!-- Enrollment Modals -->
  <div id="enrollmentModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="enrollmentModalTitle">Add/Edit Enrollment</h3>
        <span class="close-modal" id="closeEnrollmentModal">&times;</span>
      </div>
      <div class="modal-body">
        <form id="enrollmentForm">
          <input type="hidden" id="enrollmentId" />
          <div class="form-row">
            <div class="form-group">
              <label for="studentIdInput">Student ID</label>
              <input type="text" id="studentIdInput" class="form-control" autocomplete="off" required list="studentIdDatalist" />
              <datalist id="studentIdDatalist"></datalist>
              <span id="studentNameDisplay" class="student-name-display" style="display:block;min-height:1.5em;margin-top:2px;color:#6B3A1D;font-weight:500;"></span>
            </div>
            <div class="form-group">
              <label for="programInput">Program</label>
              <select id="programInput" class="form-control" required></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="sectionInput">Section</label>
              <input type="text" id="sectionInput" class="form-control" required />
            </div>
            <div class="form-group">
              <label for="yearLevelInput">Year Level</label>
              <input type="text" id="yearLevelInput" class="form-control" readonly />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex:1;">
              <label for="subjectsInput">Enrolled Courses</label>
              <select id="subjectsInput" class="form-control" multiple required></select>
              <span class="form-hint">Hold Ctrl (Windows) or Cmd (Mac) to select multiple courses</span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="unitsInput">Total Units</label>
              <input type="number" id="unitsInput" class="form-control" min="0" required />
            </div>
            <div class="form-group">
              <label for="statusInput">Status</label>
              <select id="statusInput" class="form-control" required>
                <option value="Enrolled">Enrolled</option>
                <option value="Pending">Pending</option>
                <option value="Dropped">Dropped</option>
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelEnrollmentBtn">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="viewEnrollmentModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Enrollment Details</h3>
        <span class="close-modal" id="closeViewEnrollmentModal">&times;</span>
      </div>
      <div class="modal-body" id="viewEnrollmentDetails"></div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="closeViewEnrollmentBtn">Close</button>
      </div>
    </div>
  </div>

  <script th:src="@{/js/notifications.js}"></script>
  <script th:src="@{/js/sidebar-nav.js}"></script>
  <script>
    // Enrollment table AJAX logic
    document.addEventListener("DOMContentLoaded", function () {
      loadEnrollments();
      document.getElementById("enrollmentSearchInput").addEventListener("input", function () {
        loadEnrollments(this.value);
      });
    });

    async function loadEnrollments(search = "") {
      const tbody = document.getElementById("enrollmentTableBody");
      tbody.innerHTML = '<tr><td colspan="9">Loading...</td></tr>';
      try {
        let url = "/api/enrollments";
        if (search && search.trim() !== "") {
          url += `?search=${encodeURIComponent(search)}`;
        }
        const response = await fetch(url);
        if (!response.ok) throw new Error("Failed to fetch enrollments");
        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="empty-state-message">No enrollment records found.</td></tr>';
          return;
        }
        tbody.innerHTML = data.map(e => `
          <tr>
            <td>${e.student ? (e.student.studentId || "") : ""}</td>
            <td>${e.student ? (e.student.fullName || "") : ""}</td>
            <td>${e.program ? (e.program.name || "") : ""}</td>
            <td>${e.section ? (e.section.sectionCode || "") : ""}</td>
            <td>${e.yearLevel || ""}</td>
            <td>${Array.isArray(e.enrolledSubjects) ? e.enrolledSubjects.map(s => s.courseCode).join(", ") : ""}</td>
            <td>${e.totalUnits || 0}</td>
            <td>${e.status || ""}</td>
            <td>
              <button class="btn-view" data-id="${e.id}">View</button>
              <button class="btn-edit" data-id="${e.id}">Edit</button>
              <button class="btn-delete" data-id="${e.id}">Delete</button>
            </td>
          </tr>
        `).join("");
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="9" class="empty-state-message">Error: ${err.message}</td></tr>`;
      }
    }
    // Modal logic and CRUD actions
    const enrollmentModal = document.getElementById("enrollmentModal");
    const viewEnrollmentModal = document.getElementById("viewEnrollmentModal");
    const enrollmentForm = document.getElementById("enrollmentForm");
    const addEnrollmentBtn = document.getElementById("addEnrollmentBtn");
    const closeEnrollmentModal = document.getElementById("closeEnrollmentModal");
    const closeViewEnrollmentModal = document.getElementById("closeViewEnrollmentModal");
    const cancelEnrollmentBtn = document.getElementById("cancelEnrollmentBtn");
    const closeViewEnrollmentBtn = document.getElementById("closeViewEnrollmentBtn");

    addEnrollmentBtn.onclick = function () {
      document.getElementById("enrollmentModalTitle").textContent = "Add Enrollment";
      enrollmentForm.reset();
      document.getElementById("enrollmentId").value = "";
      populateProgramDropdown();
      enrollmentModal.style.display = "block";
    };
    closeEnrollmentModal.onclick = cancelEnrollmentBtn.onclick = function () { enrollmentModal.style.display = "none"; };
    closeViewEnrollmentModal.onclick = closeViewEnrollmentBtn.onclick = function () { viewEnrollmentModal.style.display = "none"; };
    window.onclick = function (event) {
      if (event.target === enrollmentModal) enrollmentModal.style.display = "none";
      if (event.target === viewEnrollmentModal) viewEnrollmentModal.style.display = "none";
    };

    document.getElementById("enrollmentTableBody").onclick = async function (e) {
      const id = e.target.getAttribute("data-id");
      if (e.target.classList.contains("btn-view")) {
        // View
        const res = await fetch(`/api/enrollments/${id}`);
        const data = await res.json();
        document.getElementById("viewEnrollmentDetails").innerHTML = `
          <p><b>Student ID:</b> ${data.student ? (data.student.studentId || "") : ""}</p>
          <p><b>Student Name:</b> ${data.student ? (data.student.fullName || "") : ""}</p>
          <p><b>Program:</b> ${data.program ? (data.program.name || "") : ""}</p>
          <p><b>Section:</b> ${data.section ? (data.section.sectionCode || "") : ""}</p>
          <p><b>Year Level:</b> ${data.yearLevel || ""}</p>
          <p><b>Enrolled Courses:</b> ${Array.isArray(data.enrolledSubjects) ? data.enrolledSubjects.map(s => s.courseCode).join(", ") : ""}</p>
          <p><b>Units:</b> ${data.totalUnits || 0}</p>
          <p><b>Status:</b> ${data.status || ""}</p>
        `;
        viewEnrollmentModal.style.display = "block";
      } else if (e.target.classList.contains("btn-edit")) {
        // Edit
        const res = await fetch(`/api/enrollments/${id}`);
        const data = await res.json();
        document.getElementById("enrollmentModalTitle").textContent = "Edit Enrollment";
        document.getElementById("enrollmentId").value = data.id;
        document.getElementById("studentIdInput").value = data.student ? (data.student.studentId || "") : "";
        document.getElementById("programInput").value = data.program ? (data.program.name || "") : "";
        document.getElementById("sectionInput").value = data.section ? (data.section.sectionCode || "") : "";
        document.getElementById("yearLevelInput").value = data.yearLevel || "";
        document.getElementById("subjectsInput").value = Array.isArray(data.enrolledSubjects) ? data.enrolledSubjects.map(s => s.courseCode).join(", ") : "";
        document.getElementById("unitsInput").value = data.totalUnits || 0;
        document.getElementById("statusInput").value = data.status || "Enrolled";
        populateProgramDropdown(data.program ? data.program.id : "");
        enrollmentModal.style.display = "block";
      } else if (e.target.classList.contains("btn-delete")) {
        if (confirm("Are you sure you want to delete this enrollment?")) {
          await fetch(`/api/enrollments/${id}`, { method: "DELETE" });
          loadEnrollments();
        }
      }
    };

    enrollmentForm.onsubmit = async function (e) {
      e.preventDefault();
      const id = document.getElementById("enrollmentId").value;
      const programInput = document.getElementById("programInput");
      const yearLevelInput = document.getElementById("yearLevelInput");
      // Re-enable program select so value is submitted
      programInput.disabled = false;
      // Use raw yearLevel value if present
      let yearLevelRaw = yearLevelInput.dataset.value || yearLevelInput.value;
      // If yearLevelRaw is not a number, try to convert from text
      if (isNaN(yearLevelRaw) && yearLevelRaw) {
        yearLevelRaw = yearLevelTextToNumber(yearLevelRaw);
      } else if (yearLevelRaw !== null && yearLevelRaw !== undefined && yearLevelRaw !== '') {
        yearLevelRaw = parseInt(yearLevelRaw, 10);
      } else {
        yearLevelRaw = null;
      }
      const selectedCourses = Array.from(document.getElementById("subjectsInput").selectedOptions).map(o => ({ courseCode: o.value }));
      const payload = {
        student: { studentId: document.getElementById("studentIdInput").value },
        program: { id: programInput.value },
        section: { sectionCode: document.getElementById("sectionInput").value },
        yearLevel: yearLevelRaw,
        enrolledSubjects: selectedCourses,
        totalUnits: parseInt(document.getElementById("unitsInput").value, 10),
        status: document.getElementById("statusInput").value
      };
      let url = "/api/enrollments";
      let method = "POST";
      if (id) {
        url += "/" + id;
        method = "PUT";
      }
      const res = await fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        enrollmentModal.style.display = "none";
        loadEnrollments();
      } else {
        alert("Failed to save enrollment");
      }
    };

    // Populate program dropdown (like in admin-courses.html)
    async function populateProgramDropdown(selectedId) {
      const select = document.getElementById('programInput');
      select.innerHTML = '<option value="">Loading...</option>';
      try {
        const response = await fetch('/api/programs');
        const programs = await response.json();
        select.innerHTML = '<option value="">Select Program</option>' +
          programs.map(p => `<option value="${p.id}" ${selectedId == p.id ? 'selected' : ''}>${p.code} - ${p.name}</option>`).join('');
      } catch (err) {
        select.innerHTML = '<option value="">Failed to load programs</option>';
      }
    }

    // Autocomplete for student ID
    async function populateStudentIdDatalist(query = "") {
      const datalist = document.getElementById('studentIdDatalist');
      if (!query || query.length < 2) {
        datalist.innerHTML = '';
        return;
      }
      try {
        const response = await fetch(`/api/admin/users/search-students?search=${encodeURIComponent(query)}`);
        const students = await response.json();
        datalist.innerHTML = students.map(s => `<option value="${s.studentId}">${s.fullName} (${s.studentId})</option>`).join('');
      } catch (err) {
        datalist.innerHTML = '';
      }
    }

    // Display student name when a student ID is selected or entered
    function updateStudentNameDisplay(studentId) {
      const datalist = document.getElementById('studentIdDatalist');
      const nameSpan = document.getElementById('studentNameDisplay');
      if (!studentId || !datalist) {
        nameSpan.textContent = '';
        return;
      }
      // Try to find the matching option and extract the name
      const match = Array.from(datalist.options).find(opt => opt.value === studentId);
      if (match) {
        // Option label is in the format: 'Full Name (StudentId)'
        const label = match.label || match.text || '';
        // Remove the studentId in parentheses if present
        const name = label.replace(/\s*\([^)]*\)\s*$/, '').trim();
        nameSpan.textContent = name;
      } else {
        nameSpan.textContent = '';
      }
    }

    document.getElementById('studentIdInput').addEventListener('input', function() {
      populateStudentIdDatalist(this.value);
      updateStudentNameDisplay(this.value);
    });

    // --- Robust Student Autofill Logic ---
    // Helper: check if input matches a datalist option
    function isStudentIdInDatalist(inputId, datalistId) {
      const input = document.getElementById(inputId);
      const datalist = document.getElementById(datalistId);
      if (!input || !datalist) return false;
      const val = input.value;
      return Array.from(datalist.options).some(opt => opt.value === val);
    }

    // Helper: fetch user by exact studentId
    async function fetchUserByStudentId(studentId) {
      if (!studentId) return null;
      try {
        const res = await fetch(`/api/admin/users/by-student-id/${encodeURIComponent(studentId)}`);
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    // Autofill on blur, only if input matches datalist
    document.getElementById('studentIdInput').addEventListener('blur', async function() {
      const studentId = this.value;
      if (!isStudentIdInDatalist('studentIdInput', 'studentIdDatalist')) {
        // Not a valid/exact studentId, clear autofill fields
        await populateProgramDropdown();
        document.getElementById('programInput').value = '';
        document.getElementById('programInput').disabled = false;
        document.getElementById('yearLevelInput').value = '';
        document.getElementById('yearLevelInput').removeAttribute('readonly');
        document.getElementById('yearLevelInput').dataset.value = '';
        return;
      }
      // Valid/exact studentId, fetch and autofill
      const user = await fetchUserByStudentId(studentId);
      if (user) {
        await populateProgramDropdown(user.program ? user.program.id : "");
        const programInput = document.getElementById('programInput');
        programInput.value = user.program ? user.program.id : '';
        programInput.disabled = true;
        const yearLevelInput = document.getElementById('yearLevelInput');
        yearLevelInput.value = user.yearLevel ? yearLevelToText(user.yearLevel) : '';
        yearLevelInput.setAttribute('readonly', 'readonly');
        yearLevelInput.dataset.value = user.yearLevel || '';
      }
      updateStudentNameDisplay(this.value);
    });

    // Helper to convert year level number to text
    function yearLevelToText(val) {
      switch(val) {
        case '1': return 'First Year';
        case '2': return 'Second Year';
        case '3': return 'Third Year';
        case '4': return 'Fourth Year';
        case '5': return 'Fifth Year';
        default: return val || '';
      }
    }
    // Helper to convert year level text to number
    function yearLevelTextToNumber(text) {
      switch(text) {
        case 'First Year': return 1;
        case 'Second Year': return 2;
        case 'Third Year': return 3;
        case 'Fourth Year': return 4;
        case 'Fifth Year': return 5;
        default: return null;
      }
    }

    // Populate courses for selected program and year
    async function populateCoursesForProgramYear(programId, yearLevel) {
      const select = document.getElementById('subjectsInput');
      select.innerHTML = '<option>Loading...</option>';
      try {
        const res = await fetch(`/api/courses/by-program-year?programId=${programId}&yearLevel=${yearLevel}`);
        const courses = await res.json();
        select.innerHTML = courses.map(c => `<option value="${c.courseCode}">${c.courseCode} - ${c.courseTitle}</option>`).join('');
      } catch (err) {
        select.innerHTML = '<option>Failed to load courses</option>';
      }
    }
  </script>
</body>

</html>